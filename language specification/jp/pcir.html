<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PCIR仕様</title>
  <style>
    table,
    thead,
    tbody,
    th,
    td {
      border: 1px solid black;
    }

    .indent {
      padding-left: 1em;
    }
  </style>
</head>

<body>
  <h1>PCIR仕様</h1>
  <nav>
    <h2>目次</h2>
    <ul>
      <li><a href="#overview">概要</a></li>
      <li><a href="#format">形式</a></li>
    </ul>
  </nav>
  <section id="overview">
    <h2>概要</h2>
    <p>
      PCIRはPickコンパイラが用いる中間表現です。
      人間が読むことを想定しておらず、完全にバイトコードです。
      将来的にはJavaのJARのようなポータブルなライブラリ形式にする予定です。
    </p>
  </section>
  <section id="format">
    <h2>形式</h2>
    <p>
      PCIRは大きく分けて
      <ul>
        <li><a href="#format_file_header">ファイルヘッダ</a></li>
        <li><a href="#format_text_section">テキストセクション</a></li>
        <li><a href="#format_module_section">モジュールセクション</a></li>
        <li><a href="#format_type_section">タイプセクション</a></li>
        <li><a href="#format_symbol_section">シンボルセクション</a></li>
        <li><a href="#format_function_section">関数セクション</a></li>
      </ul>
      に分かれています。
      また、ファイルヘッダ以外の各セクションの先頭には
      必ずそのセクションの大きさを示す4Byte整数が格納されます。
      この値はこの値自身の大きさも含めます。
    </p>
    <section id="format_file_header">
      <h3>ファイルヘッダ</h3>
      <p>ファイルヘッダはファイル全体に関する情報が含まれます。</p>
      <p>ファイルヘッダの構造は以下です。</p>
      <table>
        <thead>
          <tr>
            <th>大きさ(Byte)</th>
            <th>オフセット(Byte)</th>
            <th>名前</th>
            <th>説明</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>4</td>
            <td>0</td>
            <td>Signature</td>
            <td>このファイルがPCIR形式であることを示すシグネチャ。値は"PCIR"。</td>
          </tr>
          <tr>
            <td>2</td>
            <td>4</td>
            <td>MajorVersion</td>
            <td>このファイルのPCIRメジャーバージョン。</td>
          </tr>
          <tr>
            <td>2</td>
            <td>6</td>
            <td>MinorVersion</td>
            <td>このファイルのPCIRマイナーバージョン。</td>
          </tr>
          <tr>
            <td>8</td>
            <td>8</td>
            <td>TimeStamp</td>
            <td>
              このファイルが作成された日時を示すUnixタイムスタンプ。
              この値は特に意味をなさないので0でも構わない。
              ファイルのバージョン管理は後続のFileIDを用いる。
            </td>
          </tr>
          <tr>
            <td>16</td>
            <td>16</td>
            <td>FileID</td>
            <td>
              このファイルのバージョン。
              異なるファイル同士の互換性維持に用いる。
              通常はUUIDv4を利用するが、異なる表現でも構わない。
              ただし、この値が一致するファイルは同じ内容であることを保証しなければならない。
            </td>
          </tr>
          <tr>
            <td>4</td>
            <td>32</td>
            <td>PointerToTextSection</td>
            <td>テキストセクションへのファイル先頭からのアドレス。</td>
          </tr>
          <tr>
            <td>4</td>
            <td>36</td>
            <td>PointerToModuleSection</td>
            <td>モジュールセクションへのファイル先頭からのアドレス。</td>
          </tr>
          <tr>
            <td>4</td>
            <td>40</td>
            <td>PointerToTypeSection</td>
            <td>タイプセクションへのファイル先頭からのアドレス。</td>
          </tr>
          <tr>
            <td>4</td>
            <td>44</td>
            <td>PointerToSymbolSection</td>
            <td>シンボルセクションへのファイル先頭からのアドレス。</td>
          </tr>
          <tr>
            <td>4</td>
            <td>48</td>
            <td>PointerToFunctionSection</td>
            <td>関数セクションへのファイル先頭からのアドレス。</td>
          </tr>
        </tbody>
      </table>
    </section>
    <section id="format_text_section">
      <h3>テキストセクション</h3>
      <p>
        テキストセクションではほかのセクションで使用される文字列を保持します。
        ほかのセクションはこのセクションのインデックスを用いて文字列を表現します。
      </p>
      <p>テキストセクションの構造は以下です。</p>
      <table>
        <thead>
          <tr>
            <th>大きさ(Byte)</th>
            <th>オフセット(Byte)</th>
            <th>名前</th>
            <th>説明</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>4</td>
            <td>0</td>
            <td>SectionSize</td>
            <td>このセクションの大きさ。</td>
          </tr>
          <tr>
            <td>4</td>
            <td>4</td>
            <td>NumberOfTexts</td>
            <td>このセクションに含まれる文字列の数。</td>
          </tr>
        </tbody>
      </table>
      <div class="indent">
        <p>この構造の直後に以下の構造がNumberOfTexts個続きます。</p>
        <table>
          <thead>
            <tr>
              <th>大きさ(Byte)</th>
              <th>オフセット(Byte)</th>
              <th>名前</th>
              <th>説明</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>4</td>
              <td>0</td>
              <td>SizeOfText</td>
              <td>このテキストのバイト数。</td>
            </tr>
            <tr>
              <td>SizeOfText</td>
              <td>4</td>
              <td>Value</td>
              <td>文字列。</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
    <section id="format_module_section">
      <h3>モジュールセクション</h3>
      <p>このセクションではこのファイルが定義するモジュールが格納されます。</p>
      <p>モジュールセクションの構造は以下です。</p>
      <table>
        <thead>
          <tr>
            <th>大きさ(Byte)</th>
            <th>オフセット(Byte)</th>
            <th>名前</th>
            <th>説明</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>4</td>
            <td>0</td>
            <td>SectionSize</td>
            <td>このセクションの大きさ。</td>
          </tr>
          <tr>
            <td>4</td>
            <td>4</td>
            <td>NumberOfModules</td>
            <td>このセクションに含まれるモジュールの数。</td>
          </tr>
        </tbody>
      </table>
      <div class="indent">
        <p>この構造の直後に以下の構造がNumberOfModules個続きます。</p>
        <table>
          <thead>
            <tr>
              <th>大きさ(Byte)</th>
              <th>オフセット(Byte)</th>
              <th>名前</th>
              <th>説明</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>4</td>
              <td>0</td>
              <td>ModuleName</td>
              <td>
                このモジュールの名前。
                完全修飾名ではなく、モジュール単体の名前でなければならない。
                値はテキストセクションのインデックス。
              </td>
            </tr>
            <tr>
              <td>4</td>
              <td>4</td>
              <td>ParentModuleName</td>
              <td>
                このモジュールの親モジュールの名前。
                完全修飾名でなければならない。
                また、親モジュールがこのファイルで定義されている必要はない。
                値はテキストセクションのインデックス。
              </td>
            </tr>
            <tr>
              <td>2</td>
              <td>8</td>
              <td>Accessibility</td>
              <td>
                このモジュールへのアクセス可能性。
                詳細については<a href="#enum_accessibility">アクセシビリティ</a>を参照。
              </td>
            </tr>
            <tr>
              <td>4</td>
              <td>10</td>
              <td>NumberOfTypes</td>
              <td>このモジュールが定義する型の数。</td>
            </tr>
            <tr>
              <td>4</td>
              <td>14</td>
              <td>NumberOfSymbols</td>
              <td>このモジュールが定義するシンボルの数。</td>
            </tr>
            <tr>
              <td>4</td>
              <td>18</td>
              <td>NumberOfFunctions</td>
              <td>このモジュールが定義する関数の数。</td>
            </tr>
            <tr>
              <td>6 * NumberOfTypes</td>
              <td>24</td>
              <td>Types</td>
              <td>
                このモジュールが定義する型の列挙。
                具体的な構造は<a href="#format_module_section_types">型情報</a>を参照。
              </td>
            </tr>
            <tr>
              <td>6 * NumberOfSymbols</td>
              <td>?</td>
              <td>Symbols</td>
              <td>
                このモジュールが定義するシンボルの列挙。
                具体的な構造は<a href="#format_module_section_symbols">シンボル情報</a>を参照。
              </td>
            </tr>
            <tr>
              <td>6 * NumberOfFunctions</td>
              <td>?</td>
              <td>Functions</td>
              <td>
                このモジュールが定義する関数の列挙。
                具体的な構造は<a href="#format_module_section_functions">関数情報</a>を参照。
              </td>
            </tr>
          </tbody>
        </table>
        <section id="format_module_section_types">
          <h4>型情報</h4>
          <p>この構造体はモジュールに属する型に関する情報が含まれます。</p>
          <p>構造は以下です。</p>
          <table>
            <thead>
              <tr>
                <th>大きさ(Byte)</th>
                <th>オフセット(Byte)</th>
                <th>名前</th>
                <th>説明</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>4</td>
                <td>0</td>
                <td>TypeIndex</td>
                <td>この型の定義へのタイプセクションのインデックス。</td>
              </tr>
              <tr>
                <td>2</td>
                <td>4</td>
                <td>Accessibility</td>
                <td>
                  この型へのアクセス可能性。
                  詳細については<a href="#enum_accessibility">アクセシビリティ</a>を参照。
                </td>
              </tr>
            </tbody>
          </table>
        </section>
        <section id="format_module_section_symbols">
          <h4>シンボル情報</h4>
          <p>この構造体はモジュールに属するシンボルに関する情報が含まれます。</p>
          <p>構造は以下です。</p>
          <table>
            <thead>
              <tr>
                <th>大きさ(Byte)</th>
                <th>オフセット(Byte)</th>
                <th>名前</th>
                <th>説明</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>4</td>
                <td>0</td>
                <td>SymbolIndex</td>
                <td>このシンボルの定義へのシンボルセクションのインデックス。</td>
              </tr>
              <tr>
                <td>2</td>
                <td>4</td>
                <td>Accessibility</td>
                <td>
                  このシンボルへのアクセス可能性。
                  詳細については<a href="#enum_accessibility">アクセシビリティ</a>を参照。
                </td>
              </tr>
            </tbody>
          </table>
        </section>
        <section id="format_module_section_functions">
          <h4>関数情報</h4>
          <p>この構造体はモジュールに属する関数に関する情報が含まれます。</p>
          <p>構造は以下です。</p>
          <table>
            <thead>
              <tr>
                <th>大きさ(Byte)</th>
                <th>オフセット(Byte)</th>
                <th>名前</th>
                <th>説明</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>4</td>
                <td>0</td>
                <td>FunctionIndex</td>
                <td>この関数の定義への関数セクションのインデックス。</td>
              </tr>
            </tbody>
          </table>
        </section>
      </div>
    </section>
    <section id="format_type_section">
      <h3>タイプセクション</h3>
      <p>
        シンボルセクションや関数セクション内で使用する型情報は、
        このセクションのインデックスです。
        インデックスは0xFFFFFF00(十進数で4294967040)以降は予約されており、
        それぞれ以下の言語定義型を意味します。
      </p>
      <table>
        <thead>
          <tr>
            <th>型名</th>
            <th>値</th>
            <th>説明</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>i8</td>
            <td>0xFFFFFF00</td>
            <td>8bit符号付き整数型。</td>
          </tr>
          <tr>
            <td>i16</td>
            <td>0xFFFFFF01</td>
            <td>16bit符号付き整数型。</td>
          </tr>
          <tr>
            <td>i32</td>
            <td>0xFFFFFF02</td>
            <td>32bit符号付き整数型。</td>
          </tr>
          <tr>
            <td>i64</td>
            <td>0xFFFFFF03</td>
            <td>64bit符号付き整数型。</td>
          </tr>
          <tr>
            <td>予約済み</td>
            <td>0xFFFFFF04 - 0xFFFFFF0E</td>
            <td>128bit以降の符号付き整数型のために予約される。</td>
          </tr>
          <tr>
            <td>isize</td>
            <td>0xFFFFFF0F</td>
            <td>各アーキテクチャごとのメモリアクセスに必要な大きさの符号付き整数。</td>
          </tr>
          <tr>
            <td>u8</td>
            <td>0xFFFFFF10</td>
            <td>8bit符号無し整数型。</td>
          </tr>
          <tr>
            <td>u16</td>
            <td>0xFFFFFF11</td>
            <td>16bit符号無し整数型。</td>
          </tr>
          <tr>
            <td>u32</td>
            <td>0xFFFFFF12</td>
            <td>32bit符号無し整数型。</td>
          </tr>
          <tr>
            <td>u64</td>
            <td>0xFFFFFF13</td>
            <td>64bit符号無し整数型。</td>
          </tr>
          <tr>
            <td>予約済み</td>
            <td>0xFFFFFF14 - 0xFFFFFF1E</td>
            <td>128bit以降の符号無し整数のために予約される。</td>
          </tr>
          <tr>
            <td>usize</td>
            <td>0xFFFFFF1F</td>
            <td>各アーキテクチャごとのメモリアクセスに必要な大きさの符号無し整数。</td>
          </tr>
          <tr>
            <td>f32</td>
            <td>0xFFFFFF20</td>
            <td>32bit単精度浮動小数点型。</td>
          </tr>
          <tr>
            <td>f64</td>
            <td>0xFFFFFF21</td>
            <td>64bit倍精度浮動小数点型。</td>
          </tr>
          <tr>
            <td>予約済み</td>
            <td>0xFFFFFF22 - 0xFFFFFF2F</td>
            <td>128bit四倍精度浮動小数点型以降の浮動小数点型のために予約される。</td>
          </tr>
          <tr>
            <td>void</td>
            <td>0xFFFFFF30</td>
            <td>void型。</td>
          </tr>
          <tr>
            <td>bool</td>
            <td>0xFFFFFF40</td>
            <td>bool型。</td>
          </tr>
        </tbody>
      </table>
      <p>タイプセクションの構造は以下です。</p>
      <table>
        <thead>
          <tr>
            <th>大きさ(Byte)</th>
            <th>オフセット(Byte)</th>
            <th>名前</th>
            <th>説明</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>4</td>
            <td>0</td>
            <td>SectionSize</td>
            <td>このセクションの大きさ。</td>
          </tr>
          <tr>
            <td>4</td>
            <td>4</td>
            <td>NumberOfTypes</td>
            <td>このセクションに含まれる型の数。</td>
          </tr>
        </tbody>
      </table>
      <div class="indent">
        <p>この構造の直後に以下の構造がNumberOfTypes個続きます。</p>
        <table>
          <thead>
            <tr>
              <th>大きさ(Byte)</th>
              <th>オフセット(Byte)</th>
              <th>名前</th>
              <th>説明</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>2</td>
              <td>0</td>
              <td>TypeKind</td>
              <td>
                この型の種類。
                詳細については<a href="#enum_type_kind">型の種類</a>を参照。
              </td>
            </tr>
          </tbody>
        </table>
        <div class="indent">
          <p>もし、TypeKindがArrayであれば、以下の構造が続きます。</p>
          <table>
            <thead>
              <tr>
                <th>大きさ(Byte)</th>
                <th>オフセット(Byte)</th>
                <th>名前</th>
                <th>説明</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>4</td>
                <td>2</td>
                <td>ElementType</td>
                <td>
                  配列の要素の型。
                  値はタイプセクションのインデックス。
                </td>
              </tr>
              <tr>
                <td>4</td>
                <td>6</td>
                <td>ArraySize</td>
                <td>配列の長さ。</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="indent">
          <p>もし、TypeKindがTupleであれば、以下の構造が続きます。</p>
          <table>
            <thead>
              <tr>
                <th>大きさ(Byte)</th>
                <th>オフセット(Byte)</th>
                <th>名前</th>
                <th>説明</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>4</td>
                <td>2</td>
                <td>NumberOfElements</td>
                <td>タプルの要素の数。</td>
              </tr>
            </tbody>
          </table>
          <div class="indent">
            <p>この直後に以下の構造がNumberOfElements個続きます。</p>
            <table>
              <thead>
                <tr>
                  <th>大きさ(Byte)</th>
                  <th>オフセット(Byte)</th>
                  <th>名前</th>
                  <th>説明</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>4</td>
                  <td>0</td>
                  <td>ElementType</td>
                  <td>
                    タプルのn番目要素の型。
                    値はタイプセクションのインデックス。
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="indent">
          <p>もし、TypeKindがPointerであれば、以下の構造が続きます。</p>
          <table>
            <thead>
              <tr>
                <th>大きさ(Byte)</th>
                <th>オフセット(Byte)</th>
                <th>名前</th>
                <th>説明</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>4</td>
                <td>2</td>
                <td>EntityType</td>
                <td>
                  ポインタの実体の型。
                  値はタイプセクションのインデックス。
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="indent">
          <p>もし、TypeKindがFunctionであれば、以下の構造が続きます。</p>
          <table>
            <thead>
              <tr>
                <th>大きさ(Byte)</th>
                <th>オフセット(Byte)</th>
                <th>名前</th>
                <th>説明</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>4</td>
                <td>2</td>
                <td>ReturnType</td>
                <td>
                  戻り値の型。
                  値はタイプセクションのインデックス。
                </td>
              </tr>
              <tr>
                <td>4</td>
                <td>6</td>
                <td>NumberOfArguments</td>
                <td>引数の数。</td>
              </tr>
            </tbody>
          </table>
          <div class="indent">
            <p>この直後に以下の構造がNumberOfArguments個続きます。</p>
            <table>
              <thead>
                <tr>
                  <th>大きさ(Byte)</th>
                  <th>オフセット(Byte)</th>
                  <th>名前</th>
                  <th>説明</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>4</td>
                  <td>0</td>
                  <td>ArgumentType</td>
                  <td>
                    n番目の引数の型。
                    値はタイプセクションのインデックス。
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="indent">
          <p>もし、TypeKindがStructureであれば、以下の構造が続きます。</p>
          <p>TODO</p>
        </div>
        <div class="indent">
          <p>もし、TypeKindがClassであれば、以下の構造が続きます。</p>
          <p>TODO</p>
        </div>
        <div class="indent">
          <p>もし、TypeKindがExternalであれば、以下の構造が続きます。</p>
          <table>
            <thead>
              <tr>
                <th>大きさ(Byte)</th>
                <th>オフセット(Byte)</th>
                <th>名前</th>
                <th>説明</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>4</td>
                <td>2</td>
                <td>TypeName</td>
                <td>
                  この型の名前。
                  完全修飾名ではない。
                </td>
              </tr>
              <tr>
                <td>4</td>
                <td>6</td>
                <td>ModuleName</td>
                <td>
                  この型の属するモジュール名。
                  完全修飾名でなければならない。
                </td>
              </tr>
              <tr>
                <td>16</td>
                <td>10</td>
                <td>FileID</td>
                <td>
                  この型が定義されているファイルのファイルID。
                  PCIR同士のリンク時に、この値が一致していなければならない。
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
    <section id="format_symbol_section">
      <h3>シンボルセクション</h3>
      <p>シンボルセクションの構造は以下です。</p>
      <table>
        <thead>
          <tr>
            <th>大きさ(Byte)</th>
            <th>オフセット(Byte)</th>
            <th>名前</th>
            <th>説明</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>4</td>
            <td>0</td>
            <td>SectionSize</td>
            <td>このセクションの大きさ。</td>
          </tr>
          <tr>
            <td>4</td>
            <td>4</td>
            <td>NumberOfSymbols</td>
            <td>このセクションに含まれるシンボルの数。</td>
          </tr>
        </tbody>
      </table>
      <div class="indent">
        <p>この構造の直後に以下の構造がNumberOfSymbols個続きます。</p>
        <table>
          <thead>
            <tr>
              <th>大きさ(Byte)</th>
              <th>オフセット(Byte)</th>
              <th>名前</th>
              <th>説明</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>4</td>
              <td>0</td>
              <td>シンボル名</td>
              <td>
                このシンボルの名前。
                完全修飾名ではない。
                値はテキストセクションのインデックス。
              </td>
            </tr>
            <tr>
              <td>2</td>
              <td>4</td>
              <td>SymbolKind</td>
              <td>
                このシンボルがこのPCIRで定義されるシンボルであるか、
                外部PCIRで定義されるシンボルであるか。
                詳細については<a href="#enum_symbol_kind">シンボルの種別</a>を参照。
              </td>
            </tr>
          </tbody>
        </table>
        <div class="indent">
          <p>もし、SymbolKindがInternalであれば、以下の構造が続きます。</p>
          <table>
            <thead>
              <tr>
                <th>大きさ(Byte)</th>
                <th>オフセット(Byte)</th>
                <th>名前</th>
                <th>説明</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>4</td>
                <td>6</td>
                <td>型</td>
                <td>
                  このシンボルの型。
                  値はタイプセクションのインデックス。
                </td>
              </tr>
              <tr>
                <td>2</td>
                <td>10</td>
                <td>Mutability</td>
                <td>
                  このシンボルの可変性。
                  詳細については<a href="#enum_mutability">ミュータビリティ</a>を参照。
                </td>
              </tr>
              <tr>
                <td>4</td>
                <td>12</td>
                <td>InitializeFunction</td>
                <td>
                  このシンボルを初期化する関数への関数セクションのインデックス。
                  この関数は引数を取らず、シンボルの型を返す関数でなければならない。
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="indent">
          <p>もし、SymbolKindがExternalであれば、以下の構造が続きます。</p>
          <table>
            <thead>
              <tr>
                <th>大きさ(Byte)</th>
                <th>オフセット(Byte)</th>
                <th>名前</th>
                <th>説明</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>4</td>
                <td>6</td>
                <td>モジュール名</td>
                <td>
                  このシンボルが属するモジュールの名前。
                  完全修飾名でなければならない。
                  値はテキストセクションのインデックス。
                </td>
              </tr>
              <tr>
                <td>16</td>
                <td>10</td>
                <td>FileID</td>
                <td>
                  このシンボルが定義されているファイルのファイルID。
                  PCIR同士のリンク時に、この値が一致していなければならない。
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
    <section id="format_function_section">
      <h3>関数セクション</h3>
      <p>関数セクションの構造は以下です。</p>
      <table>
        <thead>
          <tr>
            <th>大きさ(Byte)</th>
            <th>オフセット(Byte)</th>
            <th>名前</th>
            <th>説明</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>4</td>
            <td>0</td>
            <td>SectionSize</td>
            <td>このセクションの大きさ。</td>
          </tr>
          <tr>
            <td>4</td>
            <td>4</td>
            <td>NumberOfFunctions</td>
            <td>このセクションに含まれる関数の数。</td>
          </tr>
        </tbody>
      </table>
      <div class="indent">
        <p>この構造の直後に以下の構造がNumberOfFunctions個続きます。</p>
        <table>
          <thead>
            <tr>
              <th>大きさ(Byte)</th>
              <th>オフセット(Byte)</th>
              <th>名前</th>
              <th>説明</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>4</td>
              <td>0</td>
              <td>Type</td>
              <td>
                関数の型。
                値はタイプセクションのインデックス。
              </td>
            </tr>
            <tr>
              <td>2</td>
              <td>4</td>
              <td>FunctionKind</td>
              <td>
                関数の種別。
                詳細については<a href="#enum_function_kind">関数の種類</a>を参照。
              </td>
            </tr>
          </tbody>
        </table>
        <div class="indent">
          <p>もし、FunctionKindがInternalであれば、以下の構造が続きます。</p>
          <table>
            <thead>
              <tr>
                <th>大きさ(Byte)</th>
                <th>オフセット(Byte)</th>
                <th>名前</th>
                <th>説明</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>4</td>
                <td>6</td>
                <td>NumberOfVariables</td>
                <td>関数内で使用する変数の数。</td>
              </tr>
              <tr>
                <td>4</td>
                <td>10</td>
                <td>NumberOfBlocks</td>
                <td>この関数に含まれるブロックの数。</td>
              </tr>
            </tbody>
          </table>
          <div class="indent">
            <p>この構造の直後に以下の構造がNumberOfVariables個続きます。</p>
            <table>
              <thead>
                <tr>
                  <th>大きさ(Byte)</th>
                  <th>オフセット(Byte)</th>
                  <th>名前</th>
                  <th>説明</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>4</td>
                  <td>0</td>
                  <td>Type</td>
                  <td>
                    この変数の型。
                    値はタイプセクションのインデックス。
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="indent">
            <p>この構造の直後に以下の構造がNumberOfBlocks個続きます。</p>
            <table>
              <thead>
                <tr>
                  <th>大きさ(Byte)</th>
                  <th>オフセット(Byte)</th>
                  <th>名前</th>
                  <th>説明</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>2</td>
                  <td>0</td>
                  <td>BlockKind</td>
                  <td>
                    このブロックの種類。
                    詳細については<a href="#enum_block_kind">ブロックの種類</a>を参照。
                  </td>
                </tr>
                <tr>
                  <td>4</td>
                  <td>2</td>
                  <td>SizeOfByteCode</td>
                  <td>このブロックのバイトコードの長さ。</td>
                </tr>
              </tbody>
            </table>
            <div class="indent">
              <p>この構造の直後にBlockKindごとの構造が続きます。</p>
              <div class="indent">
                <p>もし、BlockKindがNonTerminalBlockであれば、以下の構造が続きます。</p>
                <table>
                  <thead>
                    <tr>
                      <th>大きさ(Byte)</th>
                      <th>オフセット(Byte)</th>
                      <th>名前</th>
                      <th>説明</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>4</td>
                      <td>6</td>
                      <td>NextBlock</td>
                      <td>このブロックの処理が終了した後に移動するブロックのインデックス。</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="indent">
                <p>もし、BlockKindがTerminalBlockであれば、以下の構造が続きます。</p>
                <table>
                  <thead>
                    <tr>
                      <th>大きさ(Byte)</th>
                      <th>オフセット(Byte)</th>
                      <th>名前</th>
                      <th>説明</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>4</td>
                      <td>6</td>
                      <td>ReturnValue</td>
                      <td>
                        関数が返す値への変数のインデックス。
                        この変数は初期化済みでなければならない。
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="indent">
                <p>もし、BlockKindがConditionalBranchBlockであれば、以下の構造が続きます。</p>
                <table>
                  <thead>
                    <tr>
                      <th>大きさ(Byte)</th>
                      <th>オフセット(Byte)</th>
                      <th>名前</th>
                      <th>説明</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>4</td>
                      <td>6</td>
                      <td>ConditionalValue</td>
                      <td>
                        条件を格納したbool型変数へのインデックス。
                        この変数は初期化済みでなければならない。
                      </td>
                    </tr>
                    <tr>
                      <td>4</td>
                      <td>10</td>
                      <td>ThenBlock</td>
                      <td>ConditionalValueがtrueだった場合に移動するブロックのインデックス。</td>
                    </tr>
                    <tr>
                      <td>4</td>
                      <td>14</td>
                      <td>ElseBlock</td>
                      <td>ConditionalValueがfalseだった場合に移動するブロックのインデックス。</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="indent">
            <p>
              この構造の直後にバイトコードがSizeOfByteCode続きます。
              バイトコードの詳細については<a href="#byte_code">バイトコード</a>を参照してください。
            </p>
          </div>
        </div>
        <div class="indent">
          <p>もし、FunctionKindがExternalであれば、以下の構造が続きます。</p>
          <table>
            <thead>
              <tr>
                <th>大きさ(Byte)</th>
                <th>オフセット(Byte)</th>
                <th>名前</th>
                <th>説明</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>4</td>
                <td>6</td>
                <td>ExternalName</td>
                <td>
                  この関数の名前。
                  値はテキストセクションのインデックス。
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
    <section id="enum_accessibility">
      <h3>アクセシビリティ列挙</h3>
      <p>アクセシビリティ列挙はアクセス可能性を2Byteで表します。</p>
      <p>アクセシビリティ列挙には以下の値のいずれかの値が入ります。</p>
      <table>
        <thead>
          <tr>
            <th>名前</th>
            <th>値</th>
            <th>説明</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Public</td>
            <td>0x0001</td>
            <td>どの場所からもアクセス可能である。</td>
          </tr>
          <tr>
            <td>Private</td>
            <td>0x0002</td>
            <td>それが定義された場所でのみアクセス可能である。</td>
          </tr>
        </tbody>
      </table>
    </section>
    <section id="enum_mutability">
      <h3>ミュータビリティ列挙</h3>
      <p>ミュータビリティ列挙は可変性を2Byteで表します。</p>
      <p>ミュータビリティ列挙には以下の値のいずれかの値が入ります。</p>
      <table>
        <thead>
          <tr>
            <th>名前</th>
            <th>値</th>
            <th>説明</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Mutable</td>
            <td>0x0001</td>
            <td>再代入などの書き換えが可能である。</td>
          </tr>
          <tr>
            <td>Immutable</td>
            <td>0x0002</td>
            <td>定数であり、再代入などの書き換えができない。</td>
          </tr>
        </tbody>
      </table>
    </section>
    <section id="enum_type_kind">
      <h3>型の種類</h3>
      <p>型の種類を2Byteで表します。</p>
      <p>型の種類には以下の値のいずれかの値が入ります。</p>
      <table>
        <thead>
          <tr>
            <th>名前</th>
            <th>値</th>
            <th>説明</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Array</td>
            <td>0x0001</td>
            <td>この型が配列型であることを表す。</td>
          </tr>
          <tr>
            <td>Tuple</td>
            <td>0x0002</td>
            <td>この型がタプルであることを表す。</td>
          </tr>
          <tr>
            <td>Pointer</td>
            <td>0x0003</td>
            <td>この型がポインタであることを表す。</td>
          </tr>
          <tr>
            <td>Function</td>
            <td>0x0004</td>
            <td>この型が関数であることを表す。</td>
          </tr>
          <tr>
            <td>Structure</td>
            <td>0x0005</td>
            <td>この型が構造体であることを表す。</td>
          </tr>
          <tr>
            <td>Class</td>
            <td>0x0006</td>
            <td>この型がクラスであることを表す。</td>
          </tr>
          <tr>
            <td>External</td>
            <td>0x0007</td>
            <td>この型が外部PCIR定義の型であることを表す。</td>
          </tr>
        </tbody>
      </table>
    </section>
    <section id="enum_symbol_kind">
      <h3>シンボルの種類</h3>
      <p>シンボルの種類を2Byteで表します。</p>
      <p>シンボルの種類には以下の値のいずれかの値が入ります。</p>
      <table>
        <thead>
          <tr>
            <th>名前</th>
            <th>値</th>
            <th>説明</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Internal</td>
            <td>0x0001</td>
            <td>このシンボルがこのPCIRで定義されることを表す。</td>
          </tr>
          <tr>
            <td>External</td>
            <td>0x0002</td>
            <td>このシンボルが外部PCIRで定義されることを表す。</td>
          </tr>
        </tbody>
      </table>
    </section>
    <section id="enum_function_kind">
      <h3>関数の種類</h3>
      <p>関数の種類を2Byteで表します。</p>
      <p>関数の種類には以下の値のいずれかの値が入ります。</p>
      <table>
        <thead>
          <tr>
            <th>名前</th>
            <th>値</th>
            <th>説明</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Internal</td>
            <td>0x0001</td>
            <td>この関数がこのPCIRで定義されることを表す。</td>
          </tr>
          <tr>
            <td>External</td>
            <td>0x0002</td>
            <td>この関数が外部ライブラリ(.lib, .dll, .so, etc.)で定義されることを表す。</td>
          </tr>
        </tbody>
      </table>
    </section>
    <section id="enum_block_kind">
      <h3>ブロックの種類</h3>
      <p>ブロックの種類を2Byteで表します。</p>
      <p>ブロックの種類には以下のいずれかの値が入ります。</p>
      <table>
        <thead>
          <tr>
            <th>名前</th>
            <th>値</th>
            <th>説明</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>NonTerminalBlock</td>
            <td>0x0001</td>
            <td>通常の非終端ブロックであることを表す。</td>
          </tr>
          <tr>
            <td>TerminalBlock</td>
            <td>0x0002</td>
            <td>関数の終わりなどの終端ブロックであることを表す。</td>
          </tr>
          <tr>
            <td>ConditionalBranchBlock</td>
            <td>0x0003</td>
            <td>条件分岐ブロックであることを表す。</td>
          </tr>
        </tbody>
      </table>
    </section>
  </section>
  <section id="byte_code">
    <h2>バイトコード</h2>
    <p>
      PCIRは独自の中間言語を用いています。
      静的単一代入形式を採用しており、
      Pickは代入や引数渡しが基本的にムーブになります。
      <pre>
        <code>
          fn add(x: i32, y: i32): i32 {
            return x + y;
          }
          fn main(): void {
            def a = 10;
            def b = a; // これ以降aは使用できない。
            def c = @b; // @演算子によりbをコピーしているため、これ以降もbを使用できる。
  
            def x = 5;
            def y = 8;
            def z = add(x, @y); // これ以降xは使用できないがyは使用できる。
          }
        </code>
      </pre>
    </p>
    <p>
      以下、バイトコードのフォーマットです。
      $xxxは4Byteの変数インデックスです。
      現在仕様策定中のため、オペコードは暫定値であって、
      今後命令が確定していくうちに変更される可能性があります。
    </p>
    <table>
      <thead>
        <tr>
          <th colspan="2">オペコード</th>
          <th>オペランド</th>
          <th>説明</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>ADD</td>
          <td>0x00</td>
          <td>$res, $op1, $op2</td>
          <td>
            $op1 + $op2を計算し、$resに代入する。
            $op1,$op2,$resは整数または浮動小数かつ互いに同じ型でなければならず、
            $op1,$op2は初期化済み、$resは未初期化でなければならない。
          </td>
        </tr>
        <tr>
          <td>Imm8</td>
          <td>0x80</td>
          <td>$res, imm8</td>
          <td>
            $resにimm8を代入する。
            $resは8bit整数型でなければならず、未初期化でなければならない。
            imm8は即値8bit整数である。
          </td>
        </tr>
        <tr>
          <td>Imm16</td>
          <td>0x81</td>
          <td>$res, imm16</td>
          <td>
            $resにimm16を代入する。
            $resは16bit整数型でなければならず、未初期化でなければならない。
            imm16は即値16bit整数である。
          </td>
        </tr>
        <tr>
          <td>Imm32</td>
          <td>0x82</td>
          <td>$res, imm32</td>
          <td>
            $resにimm32を代入する。
            $resは32bit整数型でなければならず、未初期化でなければならない。
            imm32は即値32bit整数である。
          </td>
        </tr>
        <tr>
          <td>Imm64</td>
          <td>0x83</td>
          <td>$res, imm64</td>
          <td>
            $resにimm64を代入する。
            $resは64bit整数型でなければならず、未初期化でなければならない
            imm64は即値64bit整数である。
          </td>
        </tr>
        <tr>
          <td>LoadFn</td>
          <td>0x90</td>
          <td>$res, imm32</td>
          <td>
            このPCIR内にある関数を$resに代入する。
            $resと読み込む関数の型は一致している必要がある。
            imm32は関数セクションの32bitインデックスである。
          </td>
        </tr>
      </tbody>
    </table>
  </section>
</body>

</html>